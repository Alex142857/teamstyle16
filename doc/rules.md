# 游戏规则说明

## 地图元素
* 矩阵棋盘式地图
* 水下（下/0）、水面（中/1）、空中（上/2）三个层次
* 同一格子的同一层次同时只能被一个元素占据

详见逻辑组API

### 地形
包括海洋和陆地

* 海洋：相当于空地，上中下层分别可停留一个单位
* 陆地：建筑和资源点均在陆地地形上，陆地地形只有空中可停留单位

### 建筑
包括基地和据点


#### 基地 Base

* 生命值无法恢复
* 弹药无限

#### 据点 Fort

* 初始状态: 无主, 无资源储备
* 生命值降为0时，所有权归致命攻击发出方，生命值立即回满，剩余资源保留

### 资源点
包括油田和矿场

* 在陆地地形上，不可被攻占
* 只能由运输舰收集获得

### 单位

* 潜艇 Submarine
* 战列舰 Battleship
* 运输舰 Cargo
* 航空母舰 Carrier
* 巡洋舰 Cruiser
* 驱逐舰 Destroyer
* 机群 Formation
    - 战斗机 Fighter
    - 鱼雷机 Torpedoer
    - 轰炸机 Bomber
    - 侦察机 Scout

#### 船舰
* 运输舰：无攻击能力，运输资源
* 只有运输舰能运输金属

#### 机群
地图上飞机单位为飞机编队

* 机种配置在生产时可调, 影响能力值
* 不可合并、降落
* 视野范围仅决定于编队是否有侦察机
* 扣除顺序: 战斗机 -> 鱼雷机 -> 轰炸机 -> 侦察机


## 游戏模式

### 指令

每回合前选手可以为己方单位设定一系列指令

* 无效的指令将被忽视
* 若为同一单位多次设定互斥的指令，则保留较后的指令
* 取消会删除当前该单位上的所有指令（生产指令除外）

指令包括：

* 攻击
* 改变目的地
* 收集
* 维修
* 生产
* 补给
* 取消


可作为指令发出方

|    单位    | 移动 | 攻击 |      补给     | 收集 | 维修 | 生产 |
|------------|------|------|---------------|------|------|------|
| ***资源*** |      |      |               |      |      |      |
| ***建筑*** |      |      |               |      |      |      |
| 基地       |      | √    | √ (除金属)    |      | √    | √    |
| 据点       |      | √    | √ (除金属，不能对空)    |      |      |      |
| ***单位*** |      |      |               |      |      |      |
| 航母       | √    | √    | √ (除金属)    |      |      |      |
| 运输舰     | √    |      | √（不能对空） | √    |      |      |
| 其他       | √    | √    |               |      |      |      |

可作为指令的接受方

|    单位    | 攻击 | 补给 | 收集 | 维修 |
|------------|------|------|------|------|
| ***建筑*** | √    | √    |      |      |
| ***资源*** |      |      | √    |      |
| ***单位*** | √    | √    |      | √    |




#### 移动

* 只能在同一层次内移动，不能穿越同层其他单位
* 每移动一格消耗一单位燃料，燃料<=0则不能继续移动
  特别地，若飞机编队燃料降至零，则坠毁，并对当前坐标的1层（水面/地面）单位造成一定伤害
* 若飞机编队未发生实际移动，视为原地盘旋一回合，消耗一单位燃料
* 当某两个同层单位单回合目的地为同一坐标时，速度大的单位移动成功，移动未成功的单位停留在
  前一格不能继续移动，若两单位速度相同，则采取随机的方式决定哪个单位移动成功

#### 攻击
|   单位   | 可造成伤害 | 可接受伤害 |
|----------|------------|------------|
| **建筑** | 火力       | 火力       |
| **单位** |            |            |
| 潜艇     | 鱼雷       | 鱼雷       |
| 船舰     | 不确定     | 火力/鱼雷  |
| 机群     | 不确定     | 火力       |

* 攻击时需指定攻击的目标坐标（射程范围内均可强制攻击）或目标索引号(必须在视野范围内才能获得索引号)
* 弹药量小于单次攻击所需弹药时不能发动攻击
* 闪避概率、伤害与距离有关
* 无队友伤害

#### 补给
运输舰、航母、据点、基地特有指令，可以对单位或建筑发动

* 航母、据点、基地可以对任意单位补给，运输舰不能补给飞机
* 设定补给量/尽力补给。（对不同单位设定了相应SUPPLY_LIMIT保证尽力补给后仍然剩余一部分资源留给自己使用）
* 补给距离为：0/1（对水下），1（对水面/地面），0（对空）

#### 收集
运输舰特有指令，从资源点获取资源

* 每次收集补满运输舰容量
* 收集距离为1

#### 维修
基地特有指令

* 对空维修距离为0，其余维修距离为1
* 维修补满生命值，消耗金属
* 维修机群可以设置机群新配置方案，按生产飞机的比例计算维修所需的回合数。维修其他单位则在一回合内完成

#### 生产
基地特有指令，给出编码后的单位类型号，生产该类型单位

* 生产后自动附加补给操作
* 生产出的单位在到基地距离为1的对应层次随机出生，若无处可放则滞留在生产列表中
* 生产消耗金属（后续补给操作该消耗什么消耗什么= =），也需要一定的回合数
* 生产过程并不影响基地的其他操作

### 结算顺序
结算顺序如下

|   结算事件   |                      更新的值                      |
|--------------|----------------------------------------------------|
| 增加生产条目 | 生产列表，基地金属                                 |
| 攻击         | 攻击方弹药，被攻击方生命值[，据点归属，据点生命值] |
| 补给         | 补给方资源，被补给方资源                           |
| 维修         | 基地金属，被维修单位生命值和资源（和类型）         |
| 收集         | 资源剩余量，所有请求资源单位的资源                 |
| 改变目的地   | 单位目的地                                         |
| 移动         | 单位坐标，燃料                                     |
| 更新生产列表 | 生产列表中剩余回合，新单位出现在地图中             |

### 距离
    abs(X1-X2)+ abs(Y1-Y2)

### 积分
    总积分 = 对敌伤害积分 + 占领据点积分（每回合奖励）+ 收集资源积分

### 初始条件
双方所有单位（包括基地）资源充满，满血据点满血无主

### 胜利条件
摧毁对方基地，或回合达到回合数上限时积分较高者获胜

### 视野范围
基地、据点、资源点位置可见，基地血量可见。每个单位均有三层视野范围，己方单位共享视野范围

### 天气
* 游戏开始时确定, 影响所有单位的视野，即

    实际视野 = 固有视野 + weather

如果出现单位视野受影响至0或负，则该单位只能看到同位置不同层次的敌人


## 伤害计算
伤害计算计算两次，分别计算火力和鱼雷伤害，弹药消耗为ammo_once
### 伤害计算公式
距离对攻方有一定影响

    修正系数 = 1 – (distance – 1) / (fire_range + 1)  // 可能大于1，近距离伤害奖励
    伤害 = （攻击 – 防御）    // 空对空: 进攻方攻击 = 进攻方战斗机攻击 (其他机种在空战中不起作用)
    攻击 = 基本攻击力 * 距离修正 * 侦察机补正
    防御 = 基本防御力

侦察机补正: 被攻击单位处在对方n架侦察机视野中, 伤害加成 n * 10%

### 闪避
    accuracy = 1 -( (distance) / (fire_range + 1))^2


### 附表：单位参数

|     属性     |  基地  |  据点  | 矿场 | 油田 |  潜艇 | 驱逐舰 | 巡洋舰 |  战舰 |  航母 | 运输舰 |      机群      |
| ------------ | ------ | ------ | ---- | ---- | ----- | ------ | ------ | ----- | ----- | ------ | -------------- |
| 视野         | 4,10,8 | 3,8,6  | None | None | 6,5,3 | 5,10,8 | 3,8,8  | 2,7,6 | 4,9,9 | 3,7,6  | 2/0,12/9,16/10 |
| 射程         | 0,7,5  | 0,5,4  | None | None | 5,5,0 | 4,9,7  | 3,7,8  | 0,6,4 | 0,8,6 | None   | 0,3,4          |
| 生命值       | 2000   | 800    | None | None | 35    | 50     | 70     | 100   | 120   | 60     | 50~80          |
| 燃料         | 1000   | 200    | None | ?    | 120   | 150    | 150    | 150   | 200   | 300    | 100~150        |
| 弹药         | INF    | 300    | None | None | 20    | 30     | 36     | 50    | 70    | 120    | 20~50          |
| 单次攻击消耗 | 6      | 4      | None | None | 2     | 3      | 3      | 5     | 2     | None   | 3              |
| 金属         | 200    | 200    | ?    | None | None  | None   | None   | None  | None  | 50     | None           |
| 速度         | None   | None   | None | None | 6     | 8      | 7      | 6     | 5     | 7      | 10             |
| 人口         | None   | None   | None | None | 2     | 2      | 3      | 4     | 4     | 1      | 3              |
| 攻击         | 40,0   | 25,0   | None | None | 0,40  | 13,20  | 24,14  | 30,0  | 15,0  | None   | 0~30,0~20      |
| 防御         | 30,INF | 12,INF | None | None | INF,5 | 10,12  | 12,14  | 16,16 | 20,8  | 15,10  | 0~20,INF       |